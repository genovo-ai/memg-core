# mcp/Dockerfile.mcp
FROM python:3.11-slim

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
WORKDIR /app

# System deps (curl for healthcheck; add build-base if you compile extras)
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

# Accept version from CI tag; fallback to latest
ARG MEMG_CORE_VERSION=
RUN if [ -n "$MEMG_CORE_VERSION" ]; then \
      V="$(echo "$MEMG_CORE_VERSION" | sed 's/^v//')"; \
      pip install --no-cache-dir "memg-core==${V}"; \
    else \
      pip install --no-cache-dir memg-core; \
    fi

# MCP server deps
RUN pip install --no-cache-dir "fastmcp>=0.2.0" "starlette>=0.37"

# Copy server entry
COPY mcp/mcp_server.py /app/

# Persistence
RUN mkdir -p /qdrant /kuzu
ENV QDRANT_STORAGE_PATH=/qdrant KUZU_DB_PATH=/kuzu/memory_db MEMORY_SYSTEM_MCP_PORT=8787

EXPOSE 8787
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f "http://localhost:${MEMORY_SYSTEM_MCP_PORT}/health" || exit 1

CMD ["python", "mcp_server.py"]
